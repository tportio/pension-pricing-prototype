import { useState } from 'react';
import { PricingCalendar } from '../components/calendar/PricingCalendar';
import { RoomDateGrid } from '../components/calendar/RoomDateGrid';
import { Card, CardHeader, CardTitle, CardContent } from '../components/common/Card';
import { Badge } from '../components/common/Badge';
import { Button } from '../components/common/Button';
import { DailyPriceEditModal } from '../components/modals/DailyPriceEditModal';
import { usePricing } from '../contexts/PricingContext';
import { cn, formatKoreanDate, formatPrice } from '../utils';
import { CHANNEL_LABELS } from '../constants';
import { Calendar, Globe, ChevronDown, ChevronUp, Edit } from 'lucide-react';
import type { Channel } from '../types';

type ViewMode = 'default' | 'calendar' | 'table';

export function PricingOverview() {
  const { state, getDailyPriceInfo } = usePricing();
  const [viewMode, setViewMode] = useState<ViewMode>('default');
  const [selectedDate, setSelectedDate] = useState<Date | null>(null);
  const [selectedChannels, setSelectedChannels] = useState<Channel[]>(['reservation', 'online']);
  const [selectedRoomIds, setSelectedRoomIds] = useState<string[]>(state.rooms.map(r => r.id));
  const [isFilterOpen, setIsFilterOpen] = useState(false);
  const [isPriceEditModalOpen, setIsPriceEditModalOpen] = useState(false);

  const handleDateClick = (date: Date) => {
    setSelectedDate(date);
  };

  const toggleChannel = (channel: Channel) => {
    setSelectedChannels(prev =>
      prev.includes(channel) ? prev.filter(c => c !== channel) : [...prev, channel]
    );
  };

  const toggleRoom = (roomId: string) => {
    setSelectedRoomIds(prev =>
      prev.includes(roomId) ? prev.filter(id => id !== roomId) : [...prev, roomId]
    );
  };

  const toggleAllRooms = (group: 'villa' | 'standard') => {
    const groupRooms = state.rooms.filter(r => r.id.includes(group));
    const allSelected = groupRooms.every(r => selectedRoomIds.includes(r.id));

    if (allSelected) {
      setSelectedRoomIds(prev => prev.filter(id => !groupRooms.some(r => r.id === id)));
    } else {
      setSelectedRoomIds(prev => [...new Set([...prev, ...groupRooms.map(r => r.id)])]);
    }
  };

  const selectedPriceInfo = selectedDate ? getDailyPriceInfo(selectedDate) : null;

  const villaRooms = state.rooms.filter(r => r.id.includes('villa'));
  const standardRooms = state.rooms.filter(r => r.id.includes('standard'));

  // í…Œì´ë¸” ë·°ìš© ë°ì´í„° ìƒì„±
  const generateTableData = () => {
    const [year, month] = state.currentMonth.split('-').map(Number);
    const startDate = new Date(year, month - 1, 1);
    const endDate = new Date(year, month, 0);

    const dates: Date[] = [];
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
      dates.push(new Date(d));
    }

    return dates;
  };

  const tableData = viewMode === 'table' ? generateTableData() : [];
  const displayRooms = selectedRoomIds.length > 0
    ? state.rooms.filter(r => selectedRoomIds.includes(r.id))
    : state.rooms;

  return (
    <div className="space-y-6">
      {/* í—¤ë”: ë·° ëª¨ë“œ ì „í™˜ */}
      <Card>
        <CardContent>
          <div className="flex items-center justify-between">
            <h2 className="text-xl font-bold text-gray-900">ğŸ’° ìš”ê¸ˆ ì „ì²´ë³´ê¸°</h2>

            {/* ë·° ëª¨ë“œ ì „í™˜ ë²„íŠ¼ */}
            <div className="flex gap-2 bg-gray-100 rounded-lg p-1">
              <button
                onClick={() => setViewMode('default')}
                className={cn(
                  'px-4 py-2 rounded-md text-sm font-medium transition-all',
                  viewMode === 'default'
                    ? 'bg-white text-gray-900 shadow-sm'
                    : 'text-gray-600 hover:text-gray-900'
                )}
              >
                ğŸ“… ê¸°ë³¸ ë·°
              </button>
              <button
                onClick={() => setViewMode('calendar')}
                className={cn(
                  'px-4 py-2 rounded-md text-sm font-medium transition-all',
                  viewMode === 'calendar'
                    ? 'bg-white text-gray-900 shadow-sm'
                    : 'text-gray-600 hover:text-gray-900'
                )}
              >
                ğŸ“† ìº˜ë¦°ë” ë·°
              </button>
              <button
                onClick={() => setViewMode('table')}
                className={cn(
                  'px-4 py-2 rounded-md text-sm font-medium transition-all',
                  viewMode === 'table'
                    ? 'bg-white text-gray-900 shadow-sm'
                    : 'text-gray-600 hover:text-gray-900'
                )}
              >
                ğŸ“Š í…Œì´ë¸” ë·°
              </button>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* í•„í„° */}
      <Card>
        <CardHeader>
          <button
            onClick={() => setIsFilterOpen(!isFilterOpen)}
            className="w-full flex items-center justify-between text-left hover:opacity-80 transition-opacity"
          >
            <CardTitle>ğŸ” í•„í„° ì„¤ì •</CardTitle>
            {isFilterOpen ? <ChevronUp className="w-5 h-5" /> : <ChevronDown className="w-5 h-5" />}
          </button>
        </CardHeader>
        {isFilterOpen && (
          <CardContent>
            <div className="space-y-4">
            {/* ì±„ë„ í•„í„° */}
            <div>
              <div className="text-sm font-medium text-gray-700 mb-2">ğŸ’° í‘œì‹œí•  ì±„ë„</div>
              <div className="flex gap-3">
                <label
                  className="flex items-center gap-2 px-4 py-2 border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors"
                  style={{
                    borderColor: selectedChannels.includes('reservation') ? '#0ea5e9' : '#e5e7eb',
                    backgroundColor: selectedChannels.includes('reservation') ? '#f0f9ff' : 'white',
                  }}
                >
                  <input
                    type="checkbox"
                    checked={selectedChannels.includes('reservation')}
                    onChange={() => toggleChannel('reservation')}
                    className="w-4 h-4"
                  />
                  <Calendar className="w-4 h-4" />
                  <span className="text-sm">ì˜ˆì•½ì°½</span>
                </label>
                <label
                  className="flex items-center gap-2 px-4 py-2 border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors"
                  style={{
                    borderColor: selectedChannels.includes('online') ? '#0ea5e9' : '#e5e7eb',
                    backgroundColor: selectedChannels.includes('online') ? '#f0f9ff' : 'white',
                  }}
                >
                  <input
                    type="checkbox"
                    checked={selectedChannels.includes('online')}
                    onChange={() => toggleChannel('online')}
                    className="w-4 h-4"
                  />
                  <Globe className="w-4 h-4" />
                  <span className="text-sm">ì˜¨ë¼ì¸</span>
                </label>
              </div>
            </div>

            {/* ê°ì‹¤ í•„í„° */}
            <div>
              <div className="text-sm font-medium text-gray-700 mb-2">ğŸ  í‘œì‹œí•  ê°ì‹¤</div>
              <div className="space-y-3">
                {/* ë…ì±„ ê°ì‹¤ */}
                <div className="border border-gray-200 rounded-lg p-3 bg-green-50">
                  <div className="flex items-center justify-between mb-2">
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={villaRooms.every(r => selectedRoomIds.includes(r.id))}
                        onChange={() => toggleAllRooms('villa')}
                        className="w-4 h-4"
                      />
                      <span className="text-sm font-semibold">ğŸ¡ ë…ì±„ ê°ì‹¤ ({villaRooms.length}ê°œ)</span>
                    </label>
                  </div>
                  <div className="grid grid-cols-5 gap-2">
                    {villaRooms.map(room => (
                      <label
                        key={room.id}
                        className="flex items-center gap-1 text-xs cursor-pointer hover:bg-white px-2 py-1 rounded"
                      >
                        <input
                          type="checkbox"
                          checked={selectedRoomIds.includes(room.id)}
                          onChange={() => toggleRoom(room.id)}
                          className="w-3 h-3"
                        />
                        <span className="truncate">{room.name}</span>
                      </label>
                    ))}
                  </div>
                </div>

                {/* ìŠ¤íƒ ë‹¤ë“œ ê°ì‹¤ */}
                <div className="border border-gray-200 rounded-lg p-3 bg-blue-50">
                  <div className="flex items-center justify-between mb-2">
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={standardRooms.every(r => selectedRoomIds.includes(r.id))}
                        onChange={() => toggleAllRooms('standard')}
                        className="w-4 h-4"
                      />
                      <span className="text-sm font-semibold">ğŸ  ìŠ¤íƒ ë‹¤ë“œ ê°ì‹¤ ({standardRooms.length}ê°œ)</span>
                    </label>
                  </div>
                  <div className="grid grid-cols-5 gap-2">
                    {standardRooms.map(room => (
                      <label
                        key={room.id}
                        className="flex items-center gap-1 text-xs cursor-pointer hover:bg-white px-2 py-1 rounded"
                      >
                        <input
                          type="checkbox"
                          checked={selectedRoomIds.includes(room.id)}
                          onChange={() => toggleRoom(room.id)}
                          className="w-3 h-3"
                        />
                        <span className="truncate">{room.name}</span>
                      </label>
                    ))}
                  </div>
                </div>
              </div>
            </div>
            </div>
          </CardContent>
        )}
      </Card>

      {/* ê¸°ë³¸ ë·°: ìº˜ë¦°ë”ì™€ ìƒì„¸ ì •ë³´ë¥¼ ê°€ë¡œë¡œ ë°°ì¹˜ */}
      {viewMode === 'default' && (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* ìº˜ë¦°ë” */}
          <div>
            <PricingCalendar
              onDateClick={handleDateClick}
              selectedChannels={selectedChannels}
              selectedRoomIds={selectedRoomIds}
            />

            {/* ë²”ë¡€ */}
            <Card className="mt-6">
            <CardHeader>
              <CardTitle>ğŸ“‹ í‘œì‹œ ë²”ë¡€</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-3">
                {/* ë°°ê²½ìƒ‰ */}
                <div>
                  <div className="text-xs font-semibold text-gray-600 mb-2">ë°°ê²½ìƒ‰</div>
                  <div className="flex flex-wrap gap-4 text-sm">
                    <div className="flex items-center gap-2">
                      <div className="w-5 h-5 bg-white border border-gray-300 rounded"></div>
                      <span className="text-gray-700">ê¸°ë³¸ ìš”ê¸ˆ</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <div className="w-5 h-5 border border-gray-300 rounded" style={{ backgroundColor: '#dbeafe' }}></div>
                      <span className="text-gray-700">ì‹œì¦Œë³„ ìƒ‰ìƒ</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <div className="w-5 h-5 bg-warning-50 border border-warning-200 rounded"></div>
                      <span className="text-gray-700">ìˆ˜ë™ ì„¤ì •</span>
                    </div>
                  </div>
                </div>

                {/* í‘œì‹œ ê¸°í˜¸ */}
                <div>
                  <div className="text-xs font-semibold text-gray-600 mb-2">í‘œì‹œ ê¸°í˜¸</div>
                  <div className="flex flex-wrap gap-4 text-sm">
                    <div className="flex items-center gap-2">
                      <span className="text-xs font-bold text-warning-700 bg-warning-200 px-1 rounded">ìˆ˜</span>
                      <span className="text-gray-700">ìˆ˜ë™ ì„¤ì • í¬í•¨</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <Badge variant="danger" className="text-xs font-bold">íœ´</Badge>
                      <span className="text-gray-700">ê³µíœ´ì¼</span>
                    </div>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>

        {/* ì„ íƒí•œ ë‚ ì§œ ìƒì„¸ ì •ë³´ */}
        <div className="lg:sticky lg:top-6 lg:self-start">
          {selectedPriceInfo && selectedDate ? (
            <Card>
              <CardHeader>
                <div className="flex items-center justify-between">
                  <CardTitle>{formatKoreanDate(selectedDate)} ìš”ê¸ˆ ìƒì„¸</CardTitle>
                  <Button
                    variant="primary"
                    size="sm"
                    onClick={() => setIsPriceEditModalOpen(true)}
                  >
                    <Edit className="w-4 h-4 mr-1" />
                    ìš”ê¸ˆ ìˆ˜ì •
                  </Button>
                </div>
              </CardHeader>
              <CardContent>

                {/* í†µê³„ */}
            <div className="grid grid-cols-3 gap-4 mb-6">
              <div className="bg-success-50 p-4 rounded-lg">
                <div className="text-sm text-gray-600 mb-1">ìµœì € ê°€ê²©</div>
                <div className="text-2xl font-bold text-success-700">
                  {formatPrice(selectedPriceInfo.minPrice)}ì›
                </div>
              </div>
              <div className="bg-danger-50 p-4 rounded-lg">
                <div className="text-sm text-gray-600 mb-1">ìµœê³  ê°€ê²©</div>
                <div className="text-2xl font-bold text-danger-700">
                  {formatPrice(selectedPriceInfo.maxPrice)}ì›
                </div>
              </div>
              <div className="bg-gray-50 p-4 rounded-lg">
                <div className="text-sm text-gray-600 mb-1">í‰ê·  ê°€ê²©</div>
                <div className="text-2xl font-bold text-gray-700">
                  {formatPrice(selectedPriceInfo.avgPrice)}ì›
                </div>
              </div>
            </div>

            {/* ê°ì‹¤ë³„ ìš”ê¸ˆ í…Œì´ë¸” - ê°ì‹¤ ë‹¨ìœ„ë¡œ ë¬¶ì–´ì„œ í‘œì‹œ */}
            <div className="space-y-4">
              {/* ê°ì‹¤ë³„ë¡œ ê·¸ë£¹í™” */}
              {Object.entries(
                selectedPriceInfo.roomPrices.reduce((acc, rp) => {
                  if (!acc[rp.roomName]) {
                    acc[rp.roomName] = [];
                  }
                  acc[rp.roomName].push(rp);
                  return acc;
                }, {} as Record<string, typeof selectedPriceInfo.roomPrices>)
              ).map(([roomName, roomPrices]) => (
                <div key={roomName} className="border border-gray-200 rounded-lg overflow-hidden">
                  {/* ê°ì‹¤ëª… í—¤ë” */}
                  <div className="bg-gray-50 px-4 py-2.5 border-b border-gray-200">
                    <h4 className="font-semibold text-gray-900">{roomName}</h4>
                  </div>

                  {/* ì±„ë„ë³„ ìš”ê¸ˆ í…Œì´ë¸” */}
                  <table className="w-full text-sm">
                    <thead className="bg-gray-50 border-b border-gray-200">
                      <tr>
                        <th className="px-4 py-2 text-left font-medium text-gray-700">ì±„ë„</th>
                        <th className="px-4 py-2 text-left font-medium text-gray-700">ì ìš© ìš”ê¸ˆ</th>
                        <th className="px-4 py-2 text-right font-medium text-gray-700">ê°ì‹¤ ìš”ê¸ˆ</th>
                        <th className="px-4 py-2 text-right font-medium text-gray-700">ì„±ì¸ ì¶”ê°€</th>
                        <th className="px-4 py-2 text-right font-medium text-gray-700">ì•„ë™ ì¶”ê°€</th>
                        <th className="px-4 py-2 text-right font-medium text-gray-700">ìœ ì•„ ì¶”ê°€</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                      {roomPrices.map((rp, index) => (
                        <tr key={index} className="hover:bg-gray-50 transition-colors">
                          <td className="px-4 py-3">
                            <Badge variant={rp.channel === 'reservation' ? 'info' : 'success'}>
                              {CHANNEL_LABELS[rp.channel]}
                            </Badge>
                          </td>
                          <td className="px-4 py-3">
                            <Badge
                              variant={
                                rp.appliedRule === 'manual'
                                  ? 'warning'
                                  : rp.appliedRule === 'season'
                                  ? 'info'
                                  : 'default'
                              }
                              className="text-xs"
                            >
                              {rp.appliedRule === 'manual'
                                ? 'âœï¸ ìˆ˜ë™'
                                : rp.appliedRule === 'season'
                                ? `ğŸ¯ ${rp.seasonName}`
                                : 'ğŸ“Œ ê¸°ë³¸'}
                            </Badge>
                          </td>
                          <td className="px-4 py-3 text-right font-semibold text-gray-900">
                            {formatPrice(rp.price)}ì›
                          </td>
                          <td className="px-4 py-3 text-right text-gray-700">
                            {formatPrice(rp.extraPersonPrices.adult)}ì›
                          </td>
                          <td className="px-4 py-3 text-right text-gray-700">
                            {formatPrice(rp.extraPersonPrices.child)}ì›
                          </td>
                          <td className="px-4 py-3 text-right text-gray-700">
                            {formatPrice(rp.extraPersonPrices.infant)}ì›
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              ))}
                </div>
              </CardContent>
            </Card>
          ) : (
            <Card>
              <CardContent>
                <div className="text-center py-12">
                  <div className="text-4xl mb-3">ğŸ“…</div>
                  <div className="text-gray-600 mb-2">ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
                  <div className="text-sm text-gray-500">
                    ìº˜ë¦°ë”ì—ì„œ ë‚ ì§œë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ ë‚ ì§œì˜ ìƒì„¸ ìš”ê¸ˆ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                  </div>
                </div>
              </CardContent>
            </Card>
          )}
          </div>
        </div>
      )}

      {/* ìº˜ë¦°ë” ë·° */}
      {viewMode === 'calendar' && (
        <RoomDateGrid
          selectedChannels={selectedChannels}
          selectedRoomIds={selectedRoomIds.length > 0 ? selectedRoomIds : undefined}
        />
      )}

      {/* í…Œì´ë¸” ë·° */}
      {viewMode === 'table' && (
        <Card>
          <CardContent>
            <div className="overflow-x-auto">
              <table className="w-full text-sm border-collapse">
                <thead>
                  <tr className="bg-gray-50">
                    <th className="border border-gray-200 px-3 py-2 text-left font-semibold text-gray-700 sticky left-0 bg-gray-50 z-10">
                      ë‚ ì§œ
                    </th>
                    <th className="border border-gray-200 px-3 py-2 text-center font-semibold text-gray-700">
                      ìš”ì¼
                    </th>
                    {displayRooms.map(room => (
                      <th
                        key={room.id}
                        className="border border-gray-200 px-3 py-2 text-center font-semibold text-gray-700"
                      >
                        {room.name}
                      </th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {tableData.map((date, index) => {
                    const dayOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][date.getDay()];
                    const priceInfo = getDailyPriceInfo(date);

                    return (
                      <tr key={index} className="hover:bg-gray-50">
                        <td className="border border-gray-200 px-3 py-2 font-medium sticky left-0 bg-white">
                          {date.getMonth() + 1}/{date.getDate()}
                        </td>
                        <td className={cn(
                          'border border-gray-200 px-3 py-2 text-center',
                          date.getDay() === 0 ? 'text-danger-600 font-semibold' :
                          date.getDay() === 6 ? 'text-primary-600 font-semibold' :
                          'text-gray-700'
                        )}>
                          {dayOfWeek}
                        </td>
                        {displayRooms.map(room => {
                          const roomPrices = priceInfo?.roomPrices.filter(
                            rp => rp.roomId === room.id && selectedChannels.includes(rp.channel)
                          ) || [];

                          return (
                            <td
                              key={room.id}
                              className="border border-gray-200 px-2 py-2 text-center text-xs"
                            >
                              {roomPrices.length > 0 ? (
                                <div className="space-y-0.5">
                                  {roomPrices.map((rp, idx) => (
                                    <div key={idx} className="flex items-center justify-center gap-1">
                                      {rp.channel === 'reservation' ? (
                                        <Calendar className="w-3 h-3 text-primary-600" />
                                      ) : (
                                        <Globe className="w-3 h-3 text-success-600" />
                                      )}
                                      <span className="font-semibold">
                                        {formatPrice(rp.price)}
                                      </span>
                                    </div>
                                  ))}
                                </div>
                              ) : (
                                <span className="text-gray-400">-</span>
                              )}
                            </td>
                          );
                        })}
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </CardContent>
        </Card>
      )}

      {/* ìš”ê¸ˆ ìˆ˜ì • ëª¨ë‹¬ */}
      <DailyPriceEditModal
        isOpen={isPriceEditModalOpen}
        onClose={() => setIsPriceEditModalOpen(false)}
        date={selectedDate}
      />
    </div>
  );
}
